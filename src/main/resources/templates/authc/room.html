<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.springframework.org/schema/mvc"
      xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">

<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
    <script th:inline="javascript">
        // ip = "116.63.138.138:8089";
        ip = "localhost:8089";
        seats = ["icon1","icon5","icon6","icon3","icon4","icon8","icon7","icon2"]
        var userId = [[${ userId }]];
        console.log(userId)
        var socket;
        var keyikai = false;

        function addRecord(names) {
            $("#xiafang").html(xiafangHtml);
            for (var i = names.length-1; i >=0; i--){
                if (names[i].trim()!=""){
                    var addHtml = "<textarea id=\""+names[i].trim()+"\" style=\"width: 675px;height: 15px\">"+names[i].trim()+"下注:</textarea><br/>"
                    $("#xiafang").html(addHtml+$("#xiafang").html())
                }
            }

        }

        function showMoney(jsonMoneys) {
            var personMoneyList = JSON.parse(jsonMoneys);
            console.log(personMoneyList)
            for(var key in personMoneyList){
                $("#"+key).html(key+"下注:"+personMoneyList[key])
            }
            //其实当前时间的积分池金额就是json里面的各数组金额之和
            $("#jifenchi").html("积分池:"+getNowAllMoney(personMoneyList))
        }

        function getNowAllMoney(personMoneyList) {
            var nowAllMoney=0;
            for(var key in personMoneyList){
                for (var i=0;i< personMoneyList[key].length;i++){
                    nowAllMoney+=personMoneyList[key][i];
                }
            }
            return nowAllMoney;
        }


        function kaipai(key) {//此处的key就是赢家的名字
            $("#"+key).html($("#"+key).html()+"       赢");
            $.get("/authc/settleAccounts/"+key, function (data) {
                if (data == "SUCCESS") {
                    alert(key+"是最后的赢家!积分已结算完毕.")
                    //此时要用ajax处理一下各玩家的金额,也可以用ajax设置新的房主,方便后续下一轮操作
                    window.location.reload();//玩完一局让各玩家重新进场,reload可以初始化页面.
                }
            });
        }

        function judgeIfShowKai() {
            if (keyikai) {
                if($("#xiazhu").is(":visible")){
                    $("#kaipai").show();
                }else{
                    $("#kaipai").hide();
                }
            }
        }

        function whoami(myName) {
            for (var i = 0; i < seats.length; i++){
                if ($("." + seats[i]).html().indexOf(myName) != -1){
                    $("." + seats[i]).css("background-color","white");
                    break;
                }
            }
        }

        //登录过后初始化socket连接
        function initSocket(userId) {
            if (typeof (WebSocket) == "undefined") {
                console.log("您的浏览器不支持WebSocket");
            } else {
                console.log("您的浏览器支持WebSocket/websocket");
            }
            //socket连接地址: 注意是ws协议
            socket = new WebSocket("ws://"+ ip +"/websocket/" + userId);
            // socket = new WebSocket("ws://./websocket/" + userId);
            socket.onopen = function () {
                console.log("Socket 已打开，並找个位置坐下,以及初始化记录表");
            };
            //获得消息事件
            socket.onmessage = function (msg) {
                console.log(msg)
                hei = msg.data+""
                if (hei.indexOf("fapai")!=-1){
                    fapai();
                    console.log("开始发牌")
                    $('#fapai').hide();
                    $('#kanpai').show();
                }else if(hei.indexOf("kanpai")!=-1){//牌面由后台传给该兄弟
                    kanpai(hei.split("#")[1]);
                    console.log("开始看牌")
                }else if(hei.indexOf("kanbianse")!=-1){
                    kanbianse(hei.split("bianse")[1],"red");
                }else if(hei.indexOf("keyikai")!=-1){
                    keyikai = true;
                    judgeIfShowKai();
                }else if(hei.indexOf("qipai")!=-1){
                    kanbianse(hei.split(":")[0],"white");
                }else if(hei.indexOf("kaipai")!=-1){
                    kaipai(hei.split(":")[1]);
                }else if(hei.indexOf("whoami")!=-1){
                    whoami(hei.split("#")[1]);
                }else if(hei.indexOf("yixiazhu")!=-1){//下注后把所有人的投注信息返回并显示
                    showMoney(hei.split("xiazhu")[1]);
                }else if(hei.indexOf(": zhunbeixia")!=-1){
                    $("#xiazhu").toggle();
                    $("#xiazhumoney").toggle();
                    $("#qipai").toggle();
                    judgeIfShowKai();
                }else if(hei.indexOf("shangzuo")!=-1){
                    var sz0 = hei.split("#")[1];
                    var money0 = hei.split("#")[2];
                    var peopleOfSeats = sz0.substring(1,sz0.length-1).split(",");
                    var moneyOfSeats = money0.substring(1,money0.length-1).split(",");
                    console.log(peopleOfSeats);
                    takeAseat(peopleOfSeats,moneyOfSeats)
                    //玩家上位后把计分处也相应重排
                    addRecord(peopleOfSeats);
                }
                else{
                    var histroy = $("#history").val();
                    $("#history").val(histroy + "\r\n" + msg.data);
                    console.log($(msg));
                }
            };
            //关闭事件
            socket.onclose = function () {
                console.log("Socket已关闭");
            };
            //错误事件
            socket.onerror = function () {
                console.log("Socket发生了错误");
            }
            $(window).unload(function () {
                socket.close();
            });
        }
        //点击按钮发送消息,指定某人和给所有人发送执行命令和发消息有具体格式要求
        function send(msg) {
            msg=msg+""
            if (msg.indexOf("zhiding")!=-1){
                socket.send("@"+ userId+"#"+ msg.split("#")[1]);
            } else if (msg.startsWith("hx")){
                socket.send('@ALL#' + msg);
            }else{
                console.log("发送消息: " + $("#msg").val());
                socket.send("@ALL#" + $("#msg").val());
                $("#msg").val("");
            }

        }

        var sleep = function(time) {
            var startTime = new Date().getTime() + parseInt(time, 10);
            while(new Date().getTime() < startTime) {}
        };

        function fapai() {
            //只有座位上有名字的人,发牌的话,才把牌显示出来
            for (var i = 0; i < seats.length; i++){
                if ($("." + seats[i]).html().indexOf("::") != -1){
                    var divs = $("."+seats[i]).children("div");
                    for (var j = 0; j < divs.length; j++) {
                        divs.eq(j).fadeIn(4000);
                    }
                }
            }
        }
        function kanpai(pai3) {
            // $("#paimian").html(pai3);
            $("#kanpai").html(pai3);
            $("#kanpai").css("background-color","white");
            send('hxkanbianse'+userId);
        }

        function kanbianse(whopankai,yanse) {
            //既然看了牌,就把自己面前的牌弄成红色,高速其他玩家已看牌,表示危险
            for (var i = 0; i < seats.length; i++){
                if ($("." + seats[i]).html().indexOf(whopankai) != -1){
                    var divs = $("."+seats[i]).children("div");
                    for (var j = 0; j < divs.length; j++) {
                        divs.eq(j).css("background-color",yanse)
                    }
                    break;
                }
            }
        }

        function takeAseat(sz,moneysz){
            for (var i = 0; i < seats.length; i++){
                //先把有名字的座位还原,然后再分配座位
                    $("."+seats[i]).html(seatHtmls[i]);
                }

            for (var i = 0; i < seats.length; i++){
                if (sz[i].trim() != ""){
                    if ($("." + seats[i]).html().indexOf("::") == -1)
                        $("."+seats[i]).html(sz[i]+ "::"+moneysz[i]+$("."+seats[i]).html())
                }
            }
        }

        function record(){
            $("#xiazhumoney").toggle();
            $("#xiazhu").toggle();//下注完就把下注按钮和下注金额框隐藏掉,然后记录下
            $("#qipai").toggle();//让弃牌按钮和下注按钮一起出现
            judgeIfShowKai();
            //任何人点击下注的话,要把下注金额存起来,因为要让所有人看到所以要发消息
            send('hxxiazhu'+$("#xiazhumoney").val());
            // $("#"+userId).html($("#"+userId).html()+$("#xiazhumoney").html()+",")
        }

        seatHtmls = []
        xiafangHtml=''
        //某人登录后就直接新建websocket进行通信
        $(document).ready(function () {
            for (var i = 0; i < seats.length; i++){
                seatHtmls.push($("."+seats[i]).html())
            }
            xiafangHtml = $("#xiafang").html()
            initSocket(userId);
        })
    </script>
    <style>
        .icon1 {
            width: 110px;
            height: 30px;
            background-color: green;
            position: absolute;
            top: 18px;
            left: 120px;
        }

        .icon2 {
            width: 110px;
            height: 30px;
            background-color: green;
            position: absolute;
            top: 18px;
            left: 520px;
        }

        .icon3 {
            width: 110px;
            height: 30px;
            background-color: green;
            position: absolute;
            left: 120px;
            bottom: -32px;
        }

        .icon4 {
            width: 110px;
            height: 30px;
            background-color: green;
            position: absolute;
            left: 520px;
            bottom: -32px;
        }

        .icon5 {
            width: 30px;
            height: 100px;
            background-color: green;
            position: absolute;
            left: 7px;
            top: 60px;
        }

        .icon6 {
            width: 30px;
            height: 100px;
            background-color: green;
            position: absolute;
            left: 7px;
            bottom: 10px;
        }

        .icon7 {
            width: 30px;
            height: 100px;
            background-color: green;
            position: absolute;
            left: 720px;
            top: 60px;
        }

        .icon8 {
            width: 30px;
            height: 100px;
            background-color: green;
            position: absolute;
            left: 720px;
            bottom: 10px;
        }

        .icon9 {
            width: 100px;
            height: 30px;
            background-color: red;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            text-align:center;
            vertical-align: middle;
            line-height: 30px;
            /* left: 50%;
            top: 50%;
            margin-left: -338px;
            margin-bottom: -150px; */
        }

        .icon10 {
            width: 100px;
            height: 30px;
            background-color: blue;
            position: absolute;
            left: 75%;
            top: 50%;
            transform: translate(-50%, -50%);
            text-align:center;
            vertical-align: middle;
            line-height: 30px;
            display:none;
        }

        .icon11 {
            width: 100px;
            height: 30px;
            background-color: blue;
            position: absolute;
            left: 25%;
            top: 50%;
            transform: translate(-50%, -50%);
            text-align:center;
            vertical-align: middle;
            line-height: 30px;
            display:none;
        }

        .xiazhu {
            width: 50px;
            height: 30px;
            background-color: red;
            position: absolute;
            left: 55%;
            top: 75%;
            transform: translate(-50%, -50%);
            text-align:center;
            vertical-align: middle;
            line-height: 30px;
            display:none;
        }

        .xiazhumoney {
            width: 50px;
            height: 30px;
            /*background-color: red;*/
            position: absolute;
            left: 45%;
            top: 75%;
            transform: translate(-50%, -50%);
            text-align:center;
            vertical-align: middle;
            line-height: 30px;
            display:none;
        }

        .jifenchi {
            width: 100px;
            height: 30px;
            background-color: yellow;
            position: absolute;
            left: 50%;
            top: 25%;
            transform: translate(-50%, -50%);
            text-align:center;
            vertical-align: middle;
            line-height: 30px;
        }

        .icons {
            width: 10px;
            height: 10px;
            background-color: gray;
            position: absolute;
            top: 40px;
            left: 20px;
            display:none;
        }

        .icona {
            width: 10px;
            height: 10px;
            background-color: gray;
            position: absolute;
            bottom: 40px;
            left: 20px;
            display:none;
        }

        .iconb {
            width: 10px;
            height: 10px;
            background-color: gray;
            position: absolute;
            top: 20px;
            left: 40px;
            display:none;
        }

        .iconc {
            width: 10px;
            height: 10px;
            background-color: gray;
            position: absolute;
            top: 20px;
            right: 40px;
            display:none;
        }
    </style>
</head>

<body>

<!--<form id="loginForm"  >
用户名: <input name="username"><br>
密&emsp;码: <input name="password">
<br>
<input type="button" value="登录" onclick="login()" />
</form>-->

<div style="display: flex;
    justify-content: space-between;position: relative;">
    <div style="border: 1px solid red;
        width: 675px;height: 300px;margin-left: 40px;
    margin-top: 50px;border-radius: 10px;position: relative;">
        <div class="jifenchi" id="jifenchi" onclick="" >积分池:0</div>
        <shiro:hasPermission name="kanpai"><div class="icon9" id="kanpai" onclick="send('zhiding#' +'kanpai')" hidden>看牌</div></shiro:hasPermission>
        <shiro:hasPermission name="fapai"><div class="icon9" id="fapai" onclick="send('hxfapai');" >发牌</div></shiro:hasPermission>
        <div class="icon11" id="qipai" onclick="$('#xiazhumoney').val(0); record();send('hxqipai');" >弃牌</div>
        <div class="icon10" id="kaipai" onclick="send('hxkaipai');" >开牌</div>
        <input type="text" id="xiazhumoney" class="xiazhumoney" value="1" />
        <div class="xiazhu" id="xiazhu" onclick="record()" >下注</div>

    </div>
    <div class="icon1">
        <div class="icons"></div>
        <div class="icons" style="margin-left: 20px;"></div>
        <div class="icons" style="margin-left: 40px;"></div>
<!--        <div class="xiazhu" style="margin-left: 40px;"><input class="xiazhu" type="text" /><input type="button" value="下注" onclick="xiazhu()" /></div>-->

    </div>
    <div class="icon2">
        <div class="icons"></div>
        <div class="icons" style="margin-left: 20px;"></div>
        <div class="icons" style="margin-left: 40px;"></div>
    </div>
    <div class="icon3">
        <div class="icona"></div>
        <div class="icona" style="margin-left: 20px;"></div>
        <div class="icona" style="margin-left: 40px;"></div>
    </div>
    <div class="icon4">
        <div class="icona"></div>
        <div class="icona" style="margin-left: 20px;"></div>
        <div class="icona" style="margin-left: 40px;"></div>
    </div>
    <div class="icon5">
        <div class="iconb"></div>
        <div class="iconb" style="margin-top: 20px;"></div>
        <div class="iconb" style="margin-top: 40px;"></div>
    </div>
    <div class="icon6">
        <div class="iconb"></div>
        <div class="iconb" style="margin-top: 20px;"></div>
        <div class="iconb" style="margin-top: 40px;"></div>
    </div>
    <div class="icon7">
        <div class="iconc"></div>
        <div class="iconc" style="margin-top: 20px;"></div>
        <div class="iconc" style="margin-top: 40px;"></div>
    </div>
    <div class="icon8">
        <div class="iconc"></div>
        <div class="iconc" style="margin-top: 20px;"></div>
        <div class="iconc" style="margin-top: 40px;"></div>
    </div>

</div>
<br/>
<br/>
<h1 id="paimian"></h1>
<!--<br/>
<br/>
<input type="text" /><input type="button" value="下注" onclick="xiazhu()" />-->
<div style="margin: 100px 20px;" id="xiafang">
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <textarea id="msg" placeholder="人到齐勒冒?开炸啊..." style="width: 675px;height: 50px"></textarea>
    <input type="button" value="发送消息" onclick="send()">
    <br>
    <textarea id="history" style="width: 675px;height: 200px ; max-lines: 10"></textarea>
</div>
</body>

</html>
